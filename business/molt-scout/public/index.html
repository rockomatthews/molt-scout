<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MOLT Scout Dashboard</title>
  <style>
    body{font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial;max-width:980px;margin:40px auto;padding:0 16px;}
    code{background:#f5f5f5;padding:2px 6px;border-radius:6px;}
    .card{border:1px solid #e5e5e5;border-radius:12px;padding:16px;margin:12px 0;}
    a{color:#0b5fff;text-decoration:none}
    a:hover{text-decoration:underline}
    .muted{color:#666}
    ul{margin:8px 0 0 18px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .pill{display:inline-block;background:#f5f5f5;border-radius:999px;padding:4px 10px;margin-right:6px}
    h1{margin-bottom:6px}
  </style>
</head>
<body>
  <h1>MOLT Scout</h1>
  <div class="muted">This dashboard reads from <code>public/latest.json</code> (generated by the daily run). Run: <code>node src/run.js</code>.</div>

  <div id="root" class="card" style="margin-top:16px">
    Loading latest…
  </div>

  <!-- Fallback for file:// usage: src/run.js writes latest.js each run -->
  <script src="./latest.js"></script>

<script>
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function linkLi(url){
  return `<li><a href="${esc(url)}" target="_blank" rel="noreferrer">${esc(url)}</a></li>`;
}

async function loadLatest(){
  try{
    const res = await fetch('./latest.json', {cache:'no-store'});
    if(res.ok) return await res.json();
  } catch (_) {}
  if (window.__MOLT_SCOUT_LATEST__) return window.__MOLT_SCOUT_LATEST__;
  throw new Error('Failed to load latest.json (likely opened via file://). Run node src/run.js, then refresh. Or serve the public/ folder over http.');
}

async function main(){
  const root = document.getElementById('root');
  try{
    const data = await loadLatest();

    const date = data.date || '(unknown date)';
    const gen = data.generatedAt ? new Date(data.generatedAt).toLocaleString() : '(unknown)';

    const shortlist = Array.isArray(data.shortlist) ? data.shortlist : [];
    const community = shortlist.filter(u=>{
      const x = String(u).toLowerCase();
      return x.includes('discord.gg') || x.includes('discord.com/invite') || x.includes('t.me/') || x.includes('telegram');
    });

    const sources = Array.isArray(data.sources) ? data.sources : [];

    root.innerHTML = `
      <div class="row">
        <div class="pill">Last run: <code>${esc(date)}</code></div>
        <div class="pill">Generated: <code>${esc(gen)}</code></div>
        <div class="pill">Shortlist: <code>${shortlist.length}</code></div>
        <div class="pill">Community links: <code>${community.length}</code></div>
      </div>

      <div class="card" style="margin-top:12px">
        <h2 style="margin:0 0 6px">Community links (priority)</h2>
        <div class="muted">Telegram/Discord links discovered across sources.</div>
        <ul>
          ${community.length ? community.slice(0,50).map(linkLi).join('') : `<li class="muted">(none found yet)</li>`}
        </ul>
      </div>

      <div class="card">
        <h2 style="margin:0 0 6px">Top shortlist</h2>
        <div class="muted">Auto-cleaned, de-duped, scored.</div>
        <ul>
          ${shortlist.slice(0,80).map(linkLi).join('')}
        </ul>
      </div>

      <div class="card">
        <h2 style="margin:0 0 6px">Sources</h2>
        <ul>
          ${sources.map(s=>`<li><strong>${esc(s.id)}</strong> — <a href="${esc(s.url)}" target="_blank" rel="noreferrer">${esc(s.url)}</a> <span class="muted">(status ${esc(s.status)})</span></li>`).join('')}
        </ul>
      </div>

      <div class="muted">Raw data: <a href="./latest.json" target="_blank" rel="noreferrer">latest.json</a></div>
    `;

  }catch(e){
    root.innerHTML = `<strong>Error:</strong> <span class="muted">${esc(e.message || e)}</span>`;
  }
}
main();
</script>
</body>
</html>
